<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Hewlett Packard Enterprise" /><link rel="canonical" href="https://scod.hpedev.io/cosi_driver/using.html" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <meta property="og:title" content="HPE Storage Container Orchestrator Documentation (SCOD)"/>
    <meta property="og:description" content="This is an umbrella documentation project for all container integrations surrounding HPE block, file and object storage. Tailored for IT ops, developers and technology partners."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://scod.hpedev.io"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://scod.hpedev.io/img/hpe-social-og-image01.png"/>
    <meta property="og:image:width" content="1200"/>
    <meta property="og:image:height" content="630"/>
    
    <title>Using - SCOD.HPEDEV.IO</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/hpedev.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Using";
        var mkdocs_page_input_path = "cosi_driver/using.md";
        var mkdocs_page_url = "/cosi_driver/using.html";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-PC28RTKKTW"></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', "G-PC28RTKKTW");
      </script>
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="..">
          <img src="../img/hpe.png" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">WELCOME</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../welcome/index.html">Get started!</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">HPE CSI DRIVER FOR KUBERNETES</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../csi_driver/index.html">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../csi_driver/deployment.html">Deployment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../csi_driver/using.html">Using</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Container Storage Providers</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../csi_driver/container_storage_provider/hpe_alletra_storage_mp_b10000/index.html">HPE Alletra Storage MP B10000, Alletra 9000, Primera and 3PAR</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../csi_driver/container_storage_provider/hpe_alletra_storage_mp_b10000_file_service/index.html">HPE Alletra Storage MP B10000 File Service</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../csi_driver/container_storage_provider/hpe_alletra_6000/index.html">HPE Alletra 5000/6000 and Nimble Storage</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../csi_driver/metrics.html">Metrics</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../csi_driver/monitor.html">Pod Monitor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../csi_driver/operations.html">Auxiliary Operations</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../csi_driver/diagnostics.html">Diagnostics</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Partner Ecosystems</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../csi_driver/partners/hpe_morpheus/install.html">HPE Morpheus Kubernetes Service</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../csi_driver/partners/hpe_ezmeral/install.html">HPE Ezmeral Runtime Enterprise</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../csi_driver/partners/amazon_eks_anywhere/index.html">Amazon EKS Anywhere</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../csi_driver/partners/canonical/index.html">Canonical</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../csi_driver/partners/cohesity/index.html">Cohesity</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../csi_driver/partners/commvault/index.html">Commvault</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../csi_driver/partners/kasten/index.html">Veeam Kasten</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../csi_driver/partners/mirantis/index.html">Mirantis</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../csi_driver/partners/redhat_openshift/index.html">Red Hat OpenShift</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../csi_driver/partners/suse_virtualization/index.html">SUSE Virtualization</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../csi_driver/partners/suse_rancher/index.html">SUSE Rancher</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../csi_driver/partners/tkgi/index.html">Tanzu TKGI</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../csi_driver/partners/vmware/index.html">VMware</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">HPE COSI DRIVER FOR KUBERNETES</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="index.html">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="deployment.html">Deployment</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Using</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#configure_a_bucketclass">Configure a BucketClass</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#optional_bucketclass_parameters">Optional BucketClass Parameters</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#create_a_bucketclaim">Create a BucketClaim</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#greenfield_bucket_provisioning">Greenfield Bucket Provisioning</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#brownfield_bucket_provisioning">Brownfield Bucket Provisioning</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#bucketaccessclass_configuration">BucketAccessClass Configuration</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#bucketaccess_configuration">BucketAccess Configuration</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#attaching_an_access_secret_to_an_object_storage_workload">Attaching an Access Secret to an Object Storage Workload</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#further_reading">Further Reading</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="diagnostics.html">Diagnostics</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">HPE GREENLAKE FOR FILE STORAGE</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../filex_csi_driver/index.html">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../filex_csi_driver/deployment.html">Deployment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../filex_csi_driver/using.html">Using</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEARN</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../learn/persistent_storage/index.html">Persistent Storage for Kubernetes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../learn/introduction_to_containers/index.html">For HPE partners:<br />&nbsp;&nbsp; Introduction to Containers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../learn/csi_primitives/index.html">Introduction to CSI Primitives</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../learn/video_gallery/index.html">Video Gallery</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../learn/csi_workshop/index.html">Interactive CSI Workshop</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">COMMUNITY</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="https://developer.hpe.com">HPE Developer</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="https://slack.hpedev.io">Sign up to HPE Developer on Slack</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="https://github.com/hpe-storage/scod/issues/new?title=I have some feedback on SCOD">Got feedback?</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">EXTERNAL LINKS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="https://github.com/hpe-storage/scod">SCOD on GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="https://github.com/hpe-storage">HPE Storage on GitHub</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="https://hpe.com/storage/containers">Storage for Containers on hpe.com</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGAL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/contributing/index.html">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/support/index.html">Support</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/license/index.html">License</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../legal/notices/index.html">Notices</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">LEGACY DRIVERS AND PLUGINS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../legacy/index.html">Docker, FlexVolume and CSPs</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">SCOD.HPEDEV.IO</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">HPE COSI DRIVER FOR KUBERNETES</li>
      <li class="breadcrumb-item active">Using</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h1>
<p>At this point the HPE COSI Driver and HPE Alletra Storage MP X10000 should be installed and configured.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>All examples below assumes there's a <code>Secret</code> with the necessary credentials to connect to the backend object storage system and HPE Data Services Cloud Console. Learn how to create the <code>Secret</code> in the <a href="deployment.html#add_an_hpe_storage_backend">Deployment section</a>.</p>
</div>
<div class="toc">
<ul>
<li><a href="#overview">Overview</a><ul>
<li><a href="#configure_a_bucketclass">Configure a BucketClass</a><ul>
<li><a href="#optional_bucketclass_parameters">Optional BucketClass Parameters</a></li>
</ul>
</li>
<li><a href="#create_a_bucketclaim">Create a BucketClaim</a><ul>
<li><a href="#greenfield_bucket_provisioning">Greenfield Bucket Provisioning</a></li>
<li><a href="#brownfield_bucket_provisioning">Brownfield Bucket Provisioning</a></li>
</ul>
</li>
<li><a href="#bucketaccessclass_configuration">BucketAccessClass Configuration</a></li>
<li><a href="#bucketaccess_configuration">BucketAccess Configuration</a><ul>
<li><a href="#attaching_an_access_secret_to_an_object_storage_workload">Attaching an Access Secret to an Object Storage Workload</a></li>
</ul>
</li>
<li><a href="#further_reading">Further Reading</a></li>
</ul>
</li>
</ul>
</div>
<h2 id="configure_a_bucketclass">Configure a BucketClass<a class="headerlink" href="#configure_a_bucketclass" title="Permanent link">&para;</a></h2>
<p>The <code>BucketClass</code> defines a set of properties that can be used to configure buckets. The <code>BucketClass</code> has a variety of fields that you can configure. An example of <code>BucketClass</code> is below. <code>BucketClasses</code> are clustered resources normally created by Kubernetes administrators.</p>
<p> <pre><code class=yaml>kind: BucketClass
apiVersion: objectstorage.k8s.io/v1alpha1
metadata:
  name: hpe-standard-object
driverName: cosi.hpe.com
deletionPolicy: Delete
parameters:
  cosiUserSecretName: hpe-object-backend
  cosiUserSecretNamespace: default
</code></pre></p>
<div class="admonition info">
<p class="admonition-title">Clarification of <code>deletionPolicy</code></p>
<p>The <code>deletionPolicy</code> is used to delete a bucket. It can be set to <code>Delete</code> or <code>Retain</code>, depending on whether the actual bucket in HPE Alletra Storage MP X10000 should be removed or retained. The associated COSI API resources <code>BucketClaim</code> and <code>Bucket</code> will be deleted regardless of the <code>deletionPolicy</code>. The <code>Bucket</code> resource can only be removed once all <code>BucketAccess</code> resources have been removed.</p>
</div>
<p>The <code>kubectl create</code> command can be used to create this resource.</p>
<p> <pre><code class=text>kubectl create -f hpe-standard-object.yaml
</code></pre></p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The <a href="deployment.html#add_an_hpe_storage_backend"><code>Secret</code></a> should be created before referring to it in the BucketClass.</p>
</div>
<h3 id="optional_bucketclass_parameters">Optional BucketClass Parameters<a class="headerlink" href="#optional_bucketclass_parameters" title="Permanent link">&para;</a></h3>
<p>Optional <code>BucketClass</code> <code>.parameters</code>.</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>String</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>bucketTags</td>
<td>Text</td>
<td>The tags to be applied on a bucket. The key-value pairs must be comma separated. In a tag, the key is required while the value is optional. Example: <code>.parameters.bucketTags: mytag1=myval1, mytag2, mytag3=myval3</code>.</td>
</tr>
</tbody>
</table>
<h2 id="create_a_bucketclaim">Create a BucketClaim<a class="headerlink" href="#create_a_bucketclaim" title="Permanent link">&para;</a></h2>
<p>The <code>BucketClaim</code> resource will be used to create a <code>Bucket</code> in COSI according to the properties specified in the <code>BucketClass</code> it refers to. Examples of Greenfield and Brownfield provisioning have been provided below. <code>BucketClaims</code> are namespaced resources normally created by applications and Kubernetes users.</p>
<h3 id="greenfield_bucket_provisioning">Greenfield Bucket Provisioning<a class="headerlink" href="#greenfield_bucket_provisioning" title="Permanent link">&para;</a></h3>
<p>You can use the following manifest to create a new bucket on the object storage system.</p>
<p> <pre><code class=yaml>kind: BucketClaim
apiVersion: objectstorage.k8s.io/v1alpha1
metadata:
  name: my-first-bucketclaim
spec:
  bucketClassName: hpe-standard-object
  protocols:
  - s3
</code></pre></p>
<p>The <code>kubectl create</code> command can be used to create this resource.</p>
<p> <pre><code class=text>kubectl create -f my-first-bucketclaim.yaml
</code></pre></p>
<p>The <code>kubectl create</code> command will create the <code>BucketClaim</code> and <code>Bucket</code> on the cluster. Check the <code>Status</code> and <code>Events</code> field of the resources' description to verify if the bucket was created successfully.</p>
<p> <pre><code class=text>kubectl get bucketclaim,bucket
NAME                               AGE
bucketclaim/my-first-bucketclaim   10d

NAME                                             AGE
bucket/bc199dde004-4f8d-4a20-900b-e5d61e3facb9   10d
</code></pre></p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The <a href="deployment.html#add_an_hpe_storage_backend"><code>Secret</code></a> and <a href="using.html#configure_a_bucketclass"><code>BucketClass</code></a> should be created before provisioning a new bucket.</p>
</div>
<p>The <code>Bucket</code> created by COSI can be deleted by deleting the associated <code>BucketClaim</code> using the <code>kubectl delete</code> command.</p>
<p> <pre><code class=text>kubectl delete bucketclaim my-first-bucketclaim
</code></pre></p>
<h3 id="brownfield_bucket_provisioning">Brownfield Bucket Provisioning<a class="headerlink" href="#brownfield_bucket_provisioning" title="Permanent link">&para;</a></h3>
<p>To map an existing bucket to a <code>BucketClaim</code> and <code>Bucket</code>, refer the following manifests. In the examples provided here the name of the existing bucket is "brownfield-bucket-name".</p>
<p> <pre><code class=yaml>apiVersion: objectstorage.k8s.io/v1alpha1
kind: Bucket
metadata:
  name: my-existing-bucket
spec:
  bucketClaim: {}
  bucketClassName: hpe-standard-object
  deletionPolicy: Delete
  driverName: cosi.hpe.com
  existingBucketID: my-existing-bucket
  parameters:
    cosiUserSecretName: hpe-object-backend
    cosiUserSecretNamespace: default
  protocols:
  - s3
</code></pre></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A <code>Bucket</code> is a clustered resource and is normally created by a Kubernetes administrator.</p>
</div>
<p>Create a <code>BucketClaim</code> referring to the pre-existing <code>Bucket</code>.</p>
<p> <pre><code class=yaml>apiVersion: objectstorage.k8s.io/v1alpha1
kind: BucketClaim
metadata:
  name: my-brownfield-bucketclaim
spec:
  bucketClassName: hpe-standard-object
  existingBucketName: my-existing-bucket
  protocols:
  - s3
</code></pre></p>
<p>The <code>kubectl create</code> command can be used to create this resource.</p>
<p> <pre><code class=text>kubectl create -f my-existing-bucket.yaml -f my-brownfield-bucketclaim.yaml
</code></pre></p>
<p>The above command will create the <code>BucketClaim</code> and <code>Bucket</code> on the cluster that maps to the existing bucket. Check the <code>Status</code> and <code>Events</code> field of the resources' description to verify if the mapping was successful.</p>
<p> <pre><code class=text>kubectl get bucketclaim,bucket
NAME                                    AGE
bucketclaim/my-brownfield-bucketclaim   72s

NAME                        AGE
bucket/my-existing-bucket   5s
</code></pre></p>
<h2 id="bucketaccessclass_configuration">BucketAccessClass Configuration<a class="headerlink" href="#bucketaccessclass_configuration" title="Permanent link">&para;</a></h2>
<p>The <code>BucketAccessClass</code> defines a set of properties that can be used to request bucket-specific access credentials. The <code>BucketAccessClass</code> has a variety of fields that can be configured according to the user's preferences. An example has been provided below. <code>BucketAccessClasses</code> are clustered resources and normally created by a Kubernetes administrator.</p>
<p> <pre><code class=yaml>kind: BucketAccessClass
apiVersion: objectstorage.k8s.io/v1alpha1
metadata:
  name: hpe-standard-access
driverName: cosi.hpe.com
authenticationType: Key
parameters:
  cosiUserSecretName: hpe-object-backend
  cosiUserSecretNamespace: default
</code></pre></p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The <code>.parameters.cosiUserSecretName</code> must reference the same <code>Secret</code> used to provision the <code>BucketClaim</code> and it must exist prior to creating a <code>BucketAccessClass</code> and <code>BucketClass</code>. See <a href="deployment.html#add_an_hpe_storage_backend">add an HPE storage backend for more details</a>.</p>
</div>
<p>The <code>kubectl create</code> command can be used to create this resource.</p>
<p> <pre><code class=text>kubectl create -f hpe-standard-access.yaml
</code></pre></p>
<h2 id="bucketaccess_configuration">BucketAccess Configuration<a class="headerlink" href="#bucketaccess_configuration" title="Permanent link">&para;</a></h2>
<p>The <code>BucketAccess</code> resource can be used to create the s3 protocol user credentials to access a particular bucket according to the properties specified in the <code>BucketAccessClass</code>. The <code>BucketAccess</code> has a variety of fields that can be configured according to the user's preferences. An example has been provided below. <code>BucketAccess</code> resources are namespaced and normally created by Kubernetes users to grant <code>BucketClaim</code> access to a workload.</p>
<p> <pre><code class=yaml>kind: BucketAccess
apiVersion: objectstorage.k8s.io/v1alpha1
metadata:
  name: my-first-bucketaccess
spec:
  bucketAccessClassName: hpe-standard-access
  credentialsSecretName: my-first-access-secret
  bucketClaimName: my-first-bucketclaim
  protocol: s3
</code></pre></p>
<p>The <code>kubectl create</code> command can be used to create this resource.</p>
<p> <pre><code class=text>kubectl create -f my-first-bucketaccess.yaml
</code></pre></p>
<p>The <code>kubectl create</code> will create the <code>BucketAccess</code> and a <code>Secret</code> in the <code>default</code> namespace of the cluster. Check the <code>Status</code> and <code>Events</code> field of the <code>BucketAccess</code> resource's description to verify if the access was granted successfully.</p>
<p> <pre><code class=text>kubectl get bucketaccess,secret
NAME                                  AGE
bucketaccess/my-first-bucketaccess    10d

NAME                              TYPE        DATA   AGE
secret/my-first-access-secret     Opaque      1      10d
</code></pre></p>
<p>To inspect the <code>Secret</code>, retrieve the content with <code>kubectl</code>, decode with <code>base64</code> and present with <code>jq</code>.</p>
<p> <pre><code class=yaml>kubectl get secret my-first-access-secret -o jsonpath='{.data.BucketInfo}' | base64 --decode | jq
{
  &quot;metadata&quot;: {
    &quot;name&quot;: &quot;bc-37fd517f-27ac-45fa-b369-57e645967366&quot;,
    &quot;creationTimestamp&quot;: null
  },
  &quot;spec&quot;: {
    &quot;bucketName&quot;: &quot;bc199dde004-4f8d-4a20-900b-e5d61e3facb9&quot;,
    &quot;authenticationType&quot;: &quot;Key&quot;,
    &quot;secretS3&quot;: {
      &quot;endpoint&quot;: &quot;http://192.168.1.100:8080&quot;,
      &quot;region&quot;: &quot;us-east-1&quot;,
      &quot;accessKeyID&quot;: &quot;user_ba-37fd517f-27ac-45fa-b369-57e645967366&quot;,
      &quot;accessSecretKey&quot;: &quot;qLe3DM0Gyoy5I7AMRqRN1Dv2gNWvvq+9EX2Qul+5tWXxgtL5DJ14i+K5UEdh+Orp&quot;
    },
    &quot;secretAzure&quot;: null,
    &quot;protocols&quot;: [
      &quot;s3&quot;
    ]
  }
}
</code></pre></p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The <code>Secret</code> generated here can be used by any COSI-enabled containerized application on the Kubernetes cluster.</p>
</div>
<p>The credentials in this <code>Secret</code> can be revoked by deleting the associated <code>BucketAccess</code> using the <code>kubectl delete</code> command.</p>
<p> <pre><code class=text>kubectl delete bucketaccess my-first-bucketaccess
</code></pre></p>
<h3 id="attaching_an_access_secret_to_an_object_storage_workload">Attaching an Access Secret to an Object Storage Workload<a class="headerlink" href="#attaching_an_access_secret_to_an_object_storage_workload" title="Permanent link">&para;</a></h3>
<p>The <code>Secret</code> specified in <code>credentialsSecretName</code> of the <code>BucketAccess</code> can be mounted as a volume to any containerized application running in a <code>Pod</code> on the Kubernetes cluster. The s3 user credentials and other relevant information will be found in the  <code>mountPath</code> to access the bucket. The workload running in the <code>Pod</code> can read this information to create an s3 client, read and write objects to the bucket using the library functions available in the <a href="https://aws.amazon.com/developer/tools/"><code>aws</code> sdk package</a> for the programming language of your choice. For more details, refer to <a href="https://github.com/kubernetes/enhancements/tree/master/keps/sig-storage/1979-object-storage-support#attaching-bucket-information-to-pods">official Kubernetes Enhancement Proposals documentation</a> on using the COSI driver with a <code>Pod</code>.</p>
<p>As an example, let us create a <code>Job</code> that runs a Python script to put and get an object in the <code>Bucket</code> using the mounted <code>Secret</code>.</p>
<p>The Python <code>aws</code> package <code>boto3</code> will be installed in the init container. The Python script is stored in a <code>ConfigMap</code> and is mounted to the init container, which will copy it to <code>PYTHONPATH=/app</code> where <code>boto3</code> is installed. <code>my-first-access-secret</code> is mounted as a volume to the main container <code>my-cosi-app</code> in the <code>mountPath: /data/cosi</code> from where the script will read the bucket-specific s3 user credentials to create the s3 client session.</p>
<p> <pre><code class=yaml>apiVersion: batch/v1
kind: Job
metadata:
  name: my-cosi-app
spec:
  template:
    spec:
      restartPolicy: Never
      initContainers:
      - name: install-boto3
        image: python:3.9
        command: [&quot;sh&quot;, &quot;-c&quot;, &quot;pip install boto3 -t /app &amp;&amp; cp /scripts/sample_pod.py /app&quot;]
        env:
        - name: http_proxy
          value: &quot;&quot;
        - name: https_proxy
          value: &quot;&quot;
        volumeMounts:
        - name: app-volume
          mountPath: /app
        - name: script-volume
          mountPath: /scripts
      containers:
      - name: my-cosi-app
        image: python:3.9
        command: [&quot;python&quot;, &quot;-u&quot;, &quot;/app/sample_pod.py&quot;]
        volumeMounts:
        - name: app-volume
          mountPath: /app
        - name: secret-volume
          mountPath: /data/cosi
        env:
        - name: PYTHONPATH
          value: &quot;/app&quot;
      volumes:
      - name: app-volume
        emptyDir: {}
      - name: script-volume
        configMap:
          name: test-object-script
      - name: secret-volume
        secret:
          secretName: my-first-access-secret
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: test-object-script
data:
  sample_pod.py: |
    #!/usr/bin/env python3

    import json
    import boto3
    import sys

    try:
        # load the bucket info
        print(&quot;Loading bucket info...&quot;)
        with open('/data/cosi/BucketInfo', 'r') as f:
            bi = json.load(f)

        # create an s3 client session
        print(&quot;Creating S3 client session...&quot;)
        session = boto3.Session(
            aws_access_key_id=bi['spec']['secretS3']['accessKeyID'],
            aws_secret_access_key=bi['spec']['secretS3']['accessSecretKey'],
        )

        s3 = session.resource(
            bi['spec']['protocols'][0], # set protocol
            endpoint_url=bi['spec']['secretS3']['endpoint'], # set endpoint
        )

        # create an object
        print(&quot;Creating object in S3 bucket...&quot;)
        s3.Object(bi['spec']['bucketName'], 'sample.txt').put(Body='Hello, World!')
        print('Object created')

        # read the object
        print('Testing the get-object operation on bucket: ' + bi['spec']['bucketName'] + ', object body: ' + s3.Object(bi['spec']['bucketName'], 'sample.txt').get()['Body'].read().decode('utf-8'))

        # Exit gracefully with zero exit code
        print(&quot;Script completed successfully.&quot;)
        sys.exit(0)

    except Exception as e:
        print(f&quot;An error occurred: {e}&quot;, file=sys.stderr)
        sys.exit(1)
</code></pre></p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You may need to set <code>http_proxy</code> and <code>https_proxy</code> environment variables of the init container to <code>pip install</code> the <code>boto3</code> package.</p>
</div>
<p>Create the <code>Job</code> and <code>ConfigMap</code>.</p>
<p> <pre><code class=text>kubectl create -f https://scod.hpedev.io/cosi_driver/examples/using/my-cosi-app.yaml
</code></pre></p>
<p>Wait for the <code>Job</code> to be completed.</p>
<p> <pre><code class=text>kubectl get job
NAME          COMPLETIONS   DURATION   AGE
my-cosi-app   1/1           15s        2m5s
</code></pre></p>
<p>The status of the <code>Pod</code> can also be tracked till completion.</p>
<p> <pre><code class=text>kubectl get pods
NAME                READY   STATUS      RESTARTS       AGE
my-cosi-app-tlr7l   0/1     Completed   0             2m9s
</code></pre></p>
<p>Once the <code>Job</code> has completed, the results of the object operations tested in the script can be found in the logs.</p>
<p> <pre><code class=text>kubectl logs jobs/my-cosi-app
Defaulted container &quot;my-cosi-app&quot; out of: my-cosi-app, install-boto3 (init)
Loading bucket info...
Creating S3 client session...
Creating object in S3 bucket...
Object created
Testing the get-object operation on bucket: bc169822df7-532e-43a2-978d-90631719f78e, object body: Hello, World!
Script completed successfully.
</code></pre></p>
<h2 id="further_reading">Further Reading<a class="headerlink" href="#further_reading" title="Permanent link">&para;</a></h2>
<p>The <a href="https://kubernetes.io/blog/2022/09/02/cosi-kubernetes-object-storage-management/">official Kubernetes documentation</a> contains comprehensive documentation on how the COSI API resources work together.</p>
              
            </div>
          </div>

<footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2020-2025 Hewlett Packard Enterprise Development LP<br />Give <a href="https://github.com/hpe-storage/scod/issues/new?title=cosi_driver/using.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/hpe-storage/scod" class="fa fa-code-fork" style="color: #fcfcfc"> hpe-storage/scod</a>
        </span>
    
    
      <span><a href="deployment.html" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="diagnostics.html" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
